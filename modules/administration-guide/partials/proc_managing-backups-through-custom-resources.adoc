
= Managing backups through custom resources

This section describes how to create backups of {prod-short} installation and do recovery directly through Custom Resource objects.

.Prerequisites

include::partial$snip_internal-backup-server-warning.adoc[]

* xref:setup-backup-server.adoc[Set up a backup server].

* xref:define-backup-server-for-operator.adoc[Configure {prod-cli} to use the backup server].

.Procedure

 * xref:operator-create-new-backup[]
 * xref:operator-restore-from-backup[]

[id="operator-create-new-backup"]
== Create a new backup

To create a new backup, create a new object of `CheClusterBackup`:

[source,yaml,subs="+attributes"]
----
apiVersion: org.eclipse.che/v1
kind: CheClusterBackup
metadata:
  name: {prod-short}-backup
spec:
  backupServerConfigRef: backup-server-configuration <1>
----
<1> Name of `CheBackupServerConfiguration` object that defines which backup server to use.

To request a new backup create a new `CheClusterBackup` object.
To reuse the same name, delete old object first.

[NOTE]
====
Editing of `CheClusterBackup` objects has no effect.
====

To automatically setup and send a backup to internal backup server, instead of configuration reference specify `useInternalBackupServer` property:

[source,yaml,subs="+attributes"]
----
apiVersion: org.eclipse.che/v1
kind: CheClusterBackup
metadata:
  name: {prod-short}-backup
spec:
  useInternalBackupServer: true
----

[id="operator-restore-from-backup"]
== Restore from a backup

To recover {prod-short} installation from a backup, create a new object of `CheClusterRestore`:

[source,yaml,subs="+attributes"]
----
apiVersion: org.eclipse.che/v1
kind: CheClusterRestore
metadata:
  name: {prod-short}-restore
spec:
  backupServerConfigRef: backup-server-configuration <1>
  snapshotId: ba92c7e0                               <2>
----
<1> Name of `CheBackupServerConfiguration` object that defines which backup server to use.
<2> Snapshot ID to restore from. Optional, defaults to the last snapshot on the backup server.

Wait until recovery finishes.
Sometimes, after recovery, it is required to clean up browser data of {prod-short}.

To request a new recovery create a new `CheClusterRestore` object.
To reuse the same name, delete old object first.

[NOTE]
====
Editing of `CheClusterRestore` objects has no effect.
====

.Verification steps

[id="verify-operator-create-new-backup"]
== Verify backup process state

To check a backup process state, read `status` section of `CheClusterBackup` object:
[source,yaml,subs="+attributes"]
----
status:
  message: 'Backup is in progress. Start time: <timestamp>' <1>
  stage: Collecting {prod-short} installation data          <2>
  state: InProgress                                         <3>
  snapshotId: ba92c7e0                                      <4>
----
<1> Overall state or error message.
<2> Current phase of backing up process in human readable format.
<3> Backing up process state. One of `InProgress`, `Succeeded` or `Failed`.
<4> ID of created backup snapshot. The field appears only when `state` is `Succeeded`.

[id="verify-operator-restore-from-backup"]
== Verify recovery process state

To check a recovery process state, read `status` section of `CheClusterRestore` object:

[source,yaml,subs="+attributes"]
----
status:
  message: 'Restore is in progress. Start time: <timestamp>' <1>
  stage: Restoring {prod-short} related cluster objects      <2>
  state: InProgress                                          <3>
----
<1> Overall state or error message.
<2> Current phase of recovery process in human readable format.
<3> Recovery process state. One of `InProgress`, `Succeeded` or `Failed`.
