
[id="migration-from-postgresql-9-to-postgresql-13_{context}"]
= Migration from PostgreSQL 9 to PostgreSQL 13

.Prerequisites

* The `{orch-cli}` tool is available.
* An instance of {prod-short} running in {orch-name}.

.Procedure

. Scale down {prod-deployment} and keycloak deployments:
+
[subs="+quotes,+attributes"]
----
{orch-cli} scale deployment {prod-deployment} --replicas=0 -n {prod-namespace}
{orch-cli} scale deployment keycloak --replicas=0 -n {prod-namespace}
----
. Backup databases:
+
[subs="+quotes,+attributes"]
----
POSTGRES_POD=$({orch-cli} get pods -n {prod-namespace} | grep postgres | awk '{print $1}')
CHE_POSTGRES_DB=$({orch-cli} get checluster/{prod-checluster} -n {prod-namespace} -o json  | jq '.spec.database.chePostgresDb')
{orch-cli} exec -it ${POSTGRES_POD} -n {prod-namespace}  -- bash  -c "pg_dump ${CHE_POSTGRES_DB} > /tmp/che.sql"
{orch-cli} exec -it ${POSTGRES_POD} -n {prod-namespace}  -- bash  -c "pg_dump keycloak > /tmp/keycloak.sql"
----
. Copy backups to a local file system:
+
[subs="+quotes,+attributes"]
----
{orch-cli} cp {prod-namespace}/${POSTGRES_POD}:/tmp/che.sql che.sql
{orch-cli} cp {prod-namespace}/${POSTGRES_POD}:/tmp/keycloak.sql keycloak.sql
----
. Scale down postgres deployment:
+
[subs="+quotes,+attributes"]
----
{orch-cli} scale deployment postgres --replicas=0 -n {prod-namespace}
----
. Delete a pvc to clean up old data:
+
[subs="+quotes,+attributes"]
----
{orch-cli} delete pvc postgres-data -n {prod-namespace}
----
. Set a new PostgreSQL version to use:
+
[subs="+quotes,+attributes"]
----
{orch-cli} patch checluster {prod-checluster} -n {prod-namespace} --type=json -p '[{"op": "replace", "path": "/spec/database/postgresVersion", "value": "13.3"}]'
----
. Scale up postgres deployments:
+
[subs="+quotes,+attributes"]
----
{orch-cli} scale deployment postgres --replicas=1 -n {prod-namespace}
{orch-cli} wait --for=condition=ready pod -l app.kubernetes.io/component=postgres -n {prod-namespace}
----
. Provision a database:
+
[subs="+quotes,+attributes"]
----
POSTGRES_POD=$({orch-cli} get pods -n {prod-namespace} | grep postgres | awk '{print $1}')
OPERATOR_POD=$({orch-cli} get pods -n {prod-namespace} | grep {prod-operator} | awk '{print $1}')
IDENTITY_POSTGRES_SECRET=$({orch-cli} exec -it ${OPERATOR_POD} -n {prod-namespace}  -- bash  -c "printenv CHE_IDENTITY_POSTGRES_SECRET" | tr -d '\r')
IDENTITY_POSTGRES_PASSWORD=$({orch-cli} get secret ${IDENTITY_POSTGRES_SECRET} -n {prod-namespace} -o json | jq -r '.data.password' | base64 -d)
{orch-cli} exec -it ${POSTGRES_POD} -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"CREATE USER keycloak WITH PASSWORD '${IDENTITY_POSTGRES_PASSWORD}'\""
{orch-cli} exec -it ${POSTGRES_POD} -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"CREATE DATABASE keycloak\""
{orch-cli} exec -it ${POSTGRES_POD} -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"GRANT ALL PRIVILEGES ON DATABASE keycloak TO keycloak\""
POSTGRES_SECRET=$({orch-cli} exec -it ${OPERATOR_POD} -n {prod-namespace}  -- bash  -c "printenv CHE_POSTGRES_SECRET" | tr -d '\r')
CHE_USER=$({orch-cli} get secret ${POSTGRES_SECRET} -n {prod-namespace} -o json | jq -r '.data.user' | base64 -d)
{orch-cli} exec -it $POSTGRES_POD -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"ALTER USER ${CHE_USER} WITH SUPERUSER\""
----
. Copy backups to PostgreSQL pod:
+
[subs="+quotes,+attributes"]
----
{orch-cli} cp che.sql {prod-namespace}/${POSTGRES_POD}:/tmp/che.sql
{orch-cli} cp keycloak.sql {prod-namespace}/${POSTGRES_POD}:/tmp/keycloak.sql
----
. Restore database:
+
[subs="+quotes,+attributes"]
----
{orch-cli} exec -it ${POSTGRES_POD} -n {prod-namespace}  -- bash  -c "psql keycloak < /tmp/keycloak.sql"
{orch-cli} exec -it ${POSTGRES_POD} -n {prod-namespace}  -- bash  -c "psql ${CHE_POSTGRES_DB} < /tmp/che.sql"
----
. Scale up keycloak and {prod-namespace} deployments:
+
[subs="+quotes,+attributes"]
----
{orch-cli} scale deployment keycloak --replicas=1 -n {prod-namespace}
{orch-cli} wait --for=condition=ready pod -l app.kubernetes.io/component=keycloak -n {prod-namespace} --timeout=120s
{orch-cli} scale deployment {prod-deployment} --replicas=1 -n {prod-namespace}
{orch-cli} wait --for=condition=ready pod -l app.kubernetes.io/component={prod-deployment} -n {prod-namespace} --timeout=120s
----
