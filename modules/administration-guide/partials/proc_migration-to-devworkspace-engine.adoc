
[id="migration-to-devworkspace-engine_{context}"]
= Upgrading {prod-short} {prod-last-version-pre-dwo} or earlier

A new workspace engine, the {devworkspace}, and a new authentication system has been introduced in version {prod-first-version-using-dwo} of {prod}. Upgrading from version {prod-last-version-pre-dwo} or earlier requires to follow the migration procedure described here.

.Prerequisites

* An instance of {prod-short} deployed using xref:installation-guide:installing-che-on-openshift-4-using-operatorhub.adoc[Operator Hub] on OpenShift cluster version greater or equal to 4.8
* OpenShift OAuth is enabled. See xref:configuring-openshift-oauth.adoc[].
* `{platforms-cli}` is available.
* Command line tools `curl`, `jq` are available.
* Bundled PostgreSQL

.Procedure

. All workspaces must be stopped and changes pushed back to Git repositories.

. Optionally backup {prod-short} data. See {prod-docs-url-backup-recovery}[{prod} {prod-last-version-pre-dwo} and earlier backup and recovery].

. Set the environment variables that will be used by the migration scripts
+
[,bash,subs="+attributes"]
----
K8S_CLI={orch-cli}
PRODUCT_DEPLOYMENT_NAME={prod-deployment}
PRODUCT_ID={prod-id}
INSTALLATION_NAMESPACE={prod-namespace}
CHE_CLUSTER_CR_NAME={prod-checluster}
IDENTITY_PROVIDER_DEPLOYMENT_NAME=keycloak
OLM_STABLE_CHANNEL={prod-stable-channel}
OLM_CATALOG_SOURCE={prod-stable-channel-catalog-source}
OLM_PACKAGE={prod-stable-channel-package}
----

. Download and execute scripts: xref:attachment$migration/1-prepare.sh[1-prepare.sh], xref:attachment$migration/2-migrate.sh[2-migrate.sh] and xref:attachment$migration/3-subscribe.sh[3-subscribe.sh].
+
[,bash,subs="+attributes"]
----
chmod +x ./1-prepare.sh ./2-migrate.sh ./3-subscribe.sh
./1-prepare.sh <1>
./2-migrate.sh <2>
./3-subscribe.sh <3>
----
<1> Shuts down {prod-short} and {identity-provider}, fetch users data and dumps {prod-short} database
<2> Migrates {prod-short} database data
<3> Deletes {prod-short} Operator and Keycloak resources, updates CheCluster CR and creates a new Operator subscription

. Wait until Operator is ready:
+
:k8s-component: {prod-operator}
:k8s-namespace: openshift-operators
include::partial$snip_waiting-for-component.adoc[]

. Wait until {prod-short} is ready:
+
:k8s-component: {prod-deployment}
:k8s-namespace: {prod-namespace}
include::partial$snip_waiting-for-component.adoc[]

include::partial$snip_verification-che-working.adoc[]
