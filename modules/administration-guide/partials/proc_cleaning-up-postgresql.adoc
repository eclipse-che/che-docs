[id="cleaning-up-postgresql{context}"]
= Cleaning up PostgreSQL

.Procedure

include::partial$snip_scaling-down-che.adoc[]

include::partial$snip_scaling-down-keycloak.adoc[]

include::partial$snip_finding-postgresql-pod.adoc[]

include::partial$snip_finding-che-database-name.adoc[]

. Drop {identity-provider} database:
+
[subs="+quotes,+attributes"]
----
{orch-cli} exec -it $POSTGRES_POD -n {prod-namespace}  -- bash  -c "dropdb keycloak"
----

. Drop {prod-short} database:
+
[subs="+quotes,+attributes"]
----
{orch-cli} exec -it $POSTGRES_POD -n {prod-namespace}  -- bash  -c "dropdb $CHE_POSTGRES_DB"
----

. Create {identity-provider} database:
+
[subs="+quotes,+attributes"]
----
{orch-cli} exec -it $POSTGRES_POD -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"CREATE DATABASE keycloak\""
{orch-cli} exec -it $POSTGRES_POD -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"GRANT ALL PRIVILEGES ON DATABASE keycloak TO keycloak\""
----

. Create {prod-short} database:
+
[subs="+quotes,+attributes"]
----
POSTGRES_SECRET=$({orch-cli} get checluster/{prod-checluster} -n {prod-namespace} -o json | jq -r '.spec.database.chePostgresSecret')
CHE_USER=$(if [ -z "$POSTGRES_SECRET" ] || [ $POSTGRES_SECRET = "null" ]; then {orch-cli} get checluster/{prod-checluster}  -n {prod-namespace} -o json | jq -r '.spec.database.chePostgresUser'; else {orch-cli} get secret $POSTGRES_SECRET -n {prod-namespace} -o json | jq -r '.data.user' | base64 -d; fi)

{orch-cli} exec -it $POSTGRES_POD -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"CREATE DATABASE $CHE_POSTGRES_DB\""
{orch-cli} exec -it $POSTGRES_POD -n {prod-namespace}  -- bash  -c "psql postgres -tAc \"GRANT ALL PRIVILEGES ON DATABASE $CHE_POSTGRES_DB TO $CHE_USER\""
----

