// Module included in the following assemblies:
//
// installing-{prod-id-short}-on-google-cloud-platform
// installing-{prod-id-short}-on-aws
// installing-{prod-id-short}-on-microsoft-azure


[id="installing-{prod-id-short}-on-kubernetes-using-{prod-cli}_and_helm_{context}"]
= Installing {prod-short} on {k8s-platform} using {prod-cli}

.Prerequisites

* The `{prod-cli}` management tool is available. See xref:using-the-chectl-management-tool.adoc[].
* The `helm` tool is available, with version 2.15 or higher. See link:https://helm.sh/[Helm].

.Procedure
ifeval::["{k8s-platform}" == "Google Cloud Platform"]
. Prepare the helmchart template `patch.yaml` file for the proper Dashboard ingress path exposure:
+
----
$ cat >patch.yaml<<EOF
> dashboard:
>   ingressPath: /dashboard/*
> EOF
----
endif::[]
. Run the following `{prod-cli}` command to install {prod-short} on {k8s-platform}:
+
[subs="+attributes"]
----
ifeval::["{k8s-platform}" == "Google Cloud Platform"]
$ {prod-cli} server:deploy --installer=helm --platform=k8s --domain={domain} --multiuser --helm-patch-yaml patch.yaml
endif::[]
ifeval::["{k8s-platform}" != "Google Cloud Platform"]
$ {prod-cli} server:deploy --installer=helm --platform=k8s --domain={domain} --multiuser
endif::[]
â€º Current {kubernetes} context: 'current-context'
  âœ” Verify {kubernetes} API...OK
  âœ” ğŸ‘€  Looking for an already existing {prod} instance
    âœ” Verify if {prod} is deployed into namespace "{prod-namespace}"...it is not
  âœ” âœˆï¸  {kubernetes} preflight checklist
    âœ” Verify if kubectl is installed
    âœ” Verify remote kubernetes status...done.
    âœ” Check {kubernetes} version: Found v1.15.12-gke.2.
    âœ” Verify domain is set...set to {domain}.
    â†“ Check if cluster accessible [skipped]
  âœ” Following {prod} logs
    â†“ Start following Operator logs [skipped]
    âœ” Start following {prod} server logs...done
    âœ” Start following Postgres logs...done
    âœ” Start following Keycloak logs...done
    âœ” Start following Plugin registry logs...done
    âœ” Start following Devfile registry logs...done
    âœ” Start following namespace events...done
  âœ” ğŸƒâ€  Running Helm to install {prod}
    âœ” Verify if helm is installed
    âœ” Check Helm Version: Found v3.4.1+gc4e7485
    âœ” Create Namespace ({prod-namespace})...does already exist.
    âœ” Check {prod} TLS certificate...self-signed TLS certificate secret found
    âœ” Check Cluster Role Binding...does not exists.
    âœ” Preparing {prod} Helm Chart...done.
    âœ” Updating Helm Chart dependencies...done.
    âœ” Deploying {prod} Helm Chart...done.
  âœ” âœ…  Post installation checklist
    âœ” PostgreSQL pod bootstrap
      âœ” Scheduling...done
      âœ” Downloading images...done
      âœ” Starting...done
    âœ” Devfile registry pod bootstrap
      âœ” Scheduling...done
      âœ” Downloading images...done
      âœ” Starting...done
    âœ” Plugin registry pod bootstrap
      âœ” Scheduling...done
      âœ” Downloading images...done
      âœ” Starting...done
    âœ” {prod} pod bootstrap
      âœ” Scheduling...done
      âœ” Downloading images...done
      âœ” Starting...done
    âœ” {prod} status check...done
  âœ” Prepare post installation output...done
  âœ” Show important messages
    âœ” {prod} {prod-ver} has been successfully deployed.
    âœ” Documentation             : {prod-docs-url}
    âœ” -------------------------------------------------------------------------------
    âœ” Users Dashboard           : https://{prod-namespace}-{prod-namespace}.{domain}
    âœ” Admin user login          : "XXX:XXX". NOTE: must change after first login.
    âœ” -------------------------------------------------------------------------------
    âœ” Plug-in Registry          : https://plugin-registry-{prod-namespace}.{domain}/v3
    âœ” Devfile Registry          : https://devfile-registry-{prod-namespace}.{domain}
    âœ” -------------------------------------------------------------------------------
    âœ” Identity Provider URL     : https://keycloak-{prod-namespace}.{domain}/auth
    âœ” Identity Provider login   : "XXX:XXX".
    âœ” -------------------------------------------------------------------------------
----

.Verification steps

. Investigate {prod} logs:
+
[subs="+attributes"]
----
$ {prod-cli} server:logs --namespace {prod-namespace}
----

. Verify that certificates are set correctly
.. Open {prod} server URL from the output above
.. Click on the lock in address bar
.. Verify it has **Connection is secure**

.Additional resources

* xref:end-user-guide:navigating-che-using-the-dashboard.adoc[].
